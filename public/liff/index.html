<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KhunPai - Create Bill</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 16px;
        background: #fafafa;
    }
    h2 {
        margin-bottom: 8px;
    }
    .field {
        margin-top: 14px;
    }
    label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
    }
    input, select {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ddd;
        box-sizing: border-box;
    }
    input:focus, select:focus {
        outline: none;
        border-color: #06c755;
    }
    input.error {
        border-color: #ff4444;
    }
    .error-message {
        color: #ff4444;
        font-size: 14px;
        margin-top: 4px;
        display: none;
    }
    .error-message.show {
        display: block;
    }
    button {
        width: 100%;
        padding: 14px;
        margin-top: 24px;
        font-size: 16px;
        font-weight: bold;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: opacity 0.2s;
    }
    button:hover:not(:disabled) {
        opacity: 0.9;
    }
    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .loading {
        display: none;
        text-align: center;
        margin-top: 20px;
        color: #666;
    }
    .loading.show {
        display: block;
    }
    .person {
        display: flex;
        align-items: center;
        margin-top: 8px;
    }

    .person label {
        margin-left: 8px;
        font-size: 16px;
    }

    .personRow {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid #e6e6e6;
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .personRow:hover {
        background-color: #f5f5f5;
    }

    .personRow input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .personName {
        display: inline;
    }

    #peopleList:empty::after {
        content: "Loading members...";
        color: #999;
        font-style: italic;
    }
  </style>
</head>
<body>

    <!-- Bill title -->
    <div class="field">
        <label for="title">Bill title</label>
        <input id="title" placeholder="e.g. Dinner" maxlength="100" />
        <div id="titleError" class="error-message">Please enter a bill title</div>
    </div>

    <!-- Pay type -->
    <div class="field">
        <label for="payType">Pay type</label>
        <select id="payType">
            <option value="equal">Equal split</option>
            <option value="each">Each pays</option>
        </select>
    </div>

    <!-- Amount -->
    <div class="field">
        <label for="amount">Amount (B)</label>
        <input id="amount" type="number" placeholder="e.g. 1200" min="0" step="0.01" />
        <div id="amountError" class="error-message">Please enter a valid amount</div>
    </div>

    <h3>Who needs to pay?</h3>
    <div id="membersError" class="error-message">Please select at least one person</div>

    <div id="peopleList"></div>

    <button id="submitBtn" onclick="submitBill()">Confirm</button>

    <div id="loading" class="loading">
        <p>Creating bill...</p>
    </div>

    <script>
    let members = [];
    let isSubmitting = false;

    async function initLIFF() {
        try {
            // Get LIFF ID from URL or use default
            const urlParams = new URLSearchParams(window.location.search);
            const liffId = urlParams.get('liffId') || "2008813600-fASkn3L4";

            await liff.init({ liffId });

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
        } catch (error) {
            console.error("LIFF initialization failed:", error);
            alert("Failed to initialize LINE app. Please try again.");
        }
    }

    function formatDateDDMMYYYY(date) {
        const d = String(date.getDate()).padStart(2, "0");
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

    function showError(fieldId, message) {
        const input = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + "Error");

        if (input) input.classList.add("error");
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add("show");
        }
    }

    function clearError(fieldId) {
        const input = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId + "Error");

        if (input) input.classList.remove("error");
        if (errorDiv) errorDiv.classList.remove("show");
    }

    function clearAllErrors() {
        clearError("title");
        clearError("amount");
        document.getElementById("membersError").classList.remove("show");
    }

    function validateInputs() {
        clearAllErrors();
        let isValid = true;

        // Validate title
        const title = document.getElementById("title").value.trim();
        if (!title) {
            showError("title", "Please enter a bill title");
            isValid = false;
        }

        // Validate amount
        const amount = Number(document.getElementById("amount").value);
        if (!amount || isNaN(amount) || amount <= 0) {
            showError("amount", "Please enter a valid positive amount");
            isValid = false;
        }

        // Validate at least one member selected
        const selected = members.filter(p =>
            document.getElementById(`member-${p.user_id}`)?.checked
        );

        if (selected.length === 0) {
            document.getElementById("membersError").classList.add("show");
            isValid = false;
        }

        return isValid;
    }

    async function submitBill() {
        // Prevent double submission
        if (isSubmitting) return;

        // Validate inputs
        if (!validateInputs()) {
            return;
        }

        const params = new URLSearchParams(window.location.search);
        const groupId = params.get("groupId");

        if (!groupId) {
            alert("Error: Missing group ID");
            return;
        }

        isSubmitting = true;

        // Disable button and show loading
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        document.getElementById("loading").classList.add("show");

        try {
            const rawTitle = document.getElementById("title").value.trim();
            const today = new Date();
            const dateStr = formatDateDDMMYYYY(today);
            const finalTitle = `${rawTitle} (${dateStr})`;

            const selected = members
                .filter(p => document.getElementById(`member-${p.user_id}`).checked)
                .map(p => p.user_id);

            const data = {
                groupId,
                title: finalTitle,
                payType: document.getElementById("payType").value,
                amount: Number(document.getElementById("amount").value),
                memberIds: selected
            };

            const response = await fetch("/api/bill", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                throw new Error(result.error || "Failed to create bill");
            }

            // Success - close LIFF window
            liff.closeWindow();

        } catch (error) {
            console.error("Error creating bill:", error);
            alert(`Failed to create bill: ${error.message || "Unknown error"}`);

            // Re-enable button
            submitBtn.disabled = false;
            document.getElementById("loading").classList.remove("show");
            isSubmitting = false;
        }
    }

    async function loadGroupMembers() {
        const params = new URLSearchParams(window.location.search);
        const groupId = params.get("groupId");

        if (!groupId) {
            alert("Error: Missing group ID");
            return;
        }

        try {
            const response = await fetch(`/api/group-members?groupId=${groupId}`);

            if (!response.ok) {
                throw new Error("Failed to fetch members");
            }

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || "Failed to load members");
            }

            members = result.members || [];

            if (members.length === 0) {
                document.getElementById("peopleList").innerHTML =
                    '<p style="color: #999; text-align: center; padding: 20px;">No members found. Members will appear after they send a message in the group.</p>';
                return;
            }

            renderPeople();

        } catch (error) {
            console.error("Error loading members:", error);
            document.getElementById("peopleList").innerHTML =
                '<p style="color: #ff4444; text-align: center; padding: 20px;">Failed to load group members. Please try again.</p>';
        }
    }

    function renderPeople() {
        const container = document.getElementById("peopleList");
        container.innerHTML = "";

        members.forEach(p => {
            const div = document.createElement("div");
            div.className = "person";

            div.innerHTML = `
                <label class="personRow">
                    <input type="checkbox" id="member-${p.user_id}" checked />
                    <span class="personName">${p.display_name || "(Unknown)"}</span>
                </label>
            `;

            // Clear member error when checkbox changes
            const checkbox = div.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', () => {
                document.getElementById("membersError").classList.remove("show");
            });

            container.appendChild(div);
        });
    }

    // Clear errors on input
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("title")?.addEventListener('input', () => clearError("title"));
        document.getElementById("amount")?.addEventListener('input', () => clearError("amount"));
    });

    // Initialize
    initLIFF().then(loadGroupMembers);
    </script>

</body>
</html>

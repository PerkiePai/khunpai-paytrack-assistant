<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KhunPai - Create Bill</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 16px;
        background: #fafafa;
    }
    h2 {
        margin-bottom: 8px;
    }
    .field {
        margin-top: 14px;
    }
    label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
    }
    input, select {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        border: 1px solid #ddd;
        box-sizing: border-box;
    }
    button {
        width: 100%;
        padding: 14px;
        margin-top: 24px;
        font-size: 16px;
        font-weight: bold;
        background-color: #06c755;
        color: white;
        border: none;
        border-radius: 10px;
    }
    .person {
        display: flex;
        align-items: center;
        margin-top: 8px;
    }

    .person label {
        margin-left: 8px;
        font-size: 16px;
    }

    /* person list row */
    .personRow{
        display:flex;
        align-items:center;
        gap:10px;
        padding:10px 12px;
        border:1px solid #e6e6e6;
        border-radius:10px;
        background:#fff;
        cursor:pointer;
    }

    /* override your global label { display:block } for this row */
    .personRow { margin:0; font-weight:500; }
    .personRow input[type="checkbox"]{ width:18px; height:18px; }
    .personName{ display:inline; }

  </style>
</head>
<body>

    <!-- Bill title -->
    <div class="field">
        <label>Bill title</label>
        <input id="title" placeholder="e.g. Dinner" />
    </div>

    <!-- Pay type -->
    <div class="field">
        <label>Pay type</label>
        <select id="payType">
        <option value="equal">Equal split</option>
        <option value="each">Each pays</option>
        </select>
    </div>

    <!-- Amount -->
    <div class="field">
        <label>Amount</label>
        <input id="amount" type="number" placeholder="e.g. 1200" />
    </div>

    <h3>ðŸ‘¥ Who needs to pay?</h3>

    <div id="peopleList"></div>

    <button onclick="submitBill()">Confirm</button>

    <script>
    async function initLIFF() {
        await liff.init({ liffId: "2008813600-fASkn3L4" });

        if (!liff.isLoggedIn()) {
        liff.login();
        return;
        }
    }

    function formatDateDDMMYYYY(date) {
        const d = String(date.getDate()).padStart(2, "0");
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

    async function submitBill() {

        const params = new URLSearchParams(window.location.search);
        const groupId = params.get("groupId");

        const rawTitle = document.getElementById("title").value.trim();
        if (!rawTitle) {
            alert("Please enter bill title");
            return;
        }

        const selected = members
            .filter(p => document.getElementById(`member-${p.id}`).checked)
            .map(p => p.id);

        if ( selected.length === 0 ) {
            alert("select at least one person");
            return;
        }

        const today = new Date();
        const dateStr = formatDateDDMMYYYY(today);
        const finalTitle = `${rawTitle} (${dateStr})`;

        const profile = await liff.getProfile();

        const data = {
            groupId,
            title: finalTitle,
            payType: document.getElementById("payType").value,
            amount: Number(document.getElementById("amount").value),
            memberIds: selected
        };

        await fetch("/api/bill", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        liff.closeWindow();
    }
    

    let members = [];

    async function loadGroupMembers() {
        const params = new URLSearchParams(window.location.search);
        const groupId = params.get("groupId");



        if (!groupId) {
            alert("missing groupId");
            return;
        }

        const respond = await fetch(`/api/group-members?groupId=${groupId}`);
        members = await respond.json();

        renderPeople();

    }

    function renderPeople() {
        const container = document.getElementById("peopleList");
        container.innerHTML = "";

        members.forEach(p => {
            const div = document.createElement("div");
            div.className = "person";

            div.innerHTML = `
                <label class="personRow">
                    <input type="checkbox" id="member-${p.id}" checked />
                    <span class="personName">${p.display_name}</span>
                </label>
            `;

            container.appendChild(div);
        });

    }

    



    initLIFF().then(loadGroupMembers);
    </script>


</body>
</html>
